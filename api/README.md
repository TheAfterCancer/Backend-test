# Orders API

A minimal order processing API for a mobile app, built with NestJS. This API provides endpoints for creating, fetching, listing, and deleting orders. Orders are stored in AWS DynamoDB, and the API is deployed on AWS Lambda behind API Gateway using Terraform and Lambda Layers.

## Table of Contents

- [Features](#features)
- [Prerequisites](#prerequisites)
- [Local Development](#local-development)
- [Testing](#testing)
- [Deployment to AWS](#deployment-to-aws)
- [Project Structure](#project-structure)
- [Environment Variables](#environment-variables)
- [License](#license)

## Features

- **RESTful Endpoints:**
  - `POST /orders` – Create a new order.
  - `GET /orders/:id` – Fetch details of a specific order.
  - `GET /orders` – List all orders.
  - `DELETE /orders/:id` – Cancel/Delete an order.
- **Authentication:**  
  Protected endpoints for order creation and updates using JWT.
- **AWS Integration:**
  - Orders are stored in DynamoDB.
  - Deployed on AWS Lambda (via Terraform) with Lambda Layers for Node modules.

## Prerequisites

- **Node.js:** v20.x or later
- **npm:** v8.x or later (or use Yarn)
- **AWS Account:** Credentials configured (via AWS CLI or environment variables)
- **Terraform:** Installed on your system (see [Terraform Installation](#terraform-installation))

### Terraform Installation

On macOS, you can install Terraform via Homebrew:

```bash
brew tap hashicorp/tap
brew install hashicorp/tap/terraform
```

Verify with:

```bash
terraform -version
```

## Local Development

1. Clone the repository:

```bash
git clone <repository-url>
cd api
```

2. Install dependencies:

```bash
npm install
```

3. Set up environment variables:

Create a .env file in the root of the project and add:

```env
AWS_REGION=eu-north-1
DYNAMODB_ENDPOINT=https://dynamodb.eu-north-1.amazonaws.com
DYNAMODB_TABLE=Orders
JWT_SECRET=your_jwt_secret
```

4. Run the application in development mode:

```bash
npm run start:dev
```

The API will be available on http://localhost:3000.

## Testing

Run unit tests using Jest:

```bash
npm run test
```

For watch mode during development:

```bash
npm run test:watch
```

## Deployment to AWS

This project uses Terraform to deploy the API to AWS Lambda, API Gateway, and DynamoDB, with Lambda Layers for dependencies.

### Steps to Deploy

1. Prepare the Lambda Function Package:

Compile the Code:

```bash
npm run build
```

2. Package Function Code:

Create a deployment directory (e.g., deploy) and copy the contents of the dist folder:

```bash
cd dist/
zip -r ../packaged_code.zip .
cd ..
```

2. Prepare the Lambda Layer for Node Modules:

Create a directory structure for the layer:

```bash
mkdir -p layer/nodejs
cp package.json layer/nodejs/
cd layer/nodejs
npm install --production
cd ../..

3. Create the layer ZIP:

```bash
cd layer
zip -r ../node_layer.zip nodejs
cd ..
```

4. Configure AWS Credentials:

Ensure your AWS CLI is configured with appropriate credentials:

```bash
aws configure
```

5. Deploy with Terraform:

Initialize Terraform in the project directory:

```bash
terraform init
```

Preview the changes:

```bash
terraform plan
```

Apply the configuration:

```bash
terraform apply
```

After deployment, Terraform outputs the API Gateway endpoint. Use this endpoint to access your API.

## Project Structure

```bash
api/
├── src/
│   ├── auth/
│   ├── orders/
│   ├── exceptions/
│   ├── app.module.ts
│   ├── main.ts
│   └── lambda.ts          # Lambda entry file exporting `handler`
├── dist/                  # Compiled code (generated by `npm run build`)
├── layer/                 # Contains Lambda layer files (nodejs folder)
│   └── nodejs/
│       ├── node_modules/
│       ├── package.json
│       └── package-lock.json
├── packaged_code.zip      # Deployment package for Lambda function
├── node_modules_layer.zip # Deployment package for Lambda layer
├── package.json
├── tsconfig.json
└── README.md
```

## Environment Variables

### Local Development:

Use the .env file with the @nestjs/config module.

### AWS Lambda:

Environment variables are set in the Lambda function configuration via Terraform. See the environment block in main.tf.

## License
This project is licensed under the UNLICENSED license.

